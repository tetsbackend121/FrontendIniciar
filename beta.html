<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://frontendiniciar.onrender.com/css/styles.css">
    <title>Bienvenido</title>
</head>
<body>
    <div class="container">
        <h1 id="nombre">Bienvenido, <span id="usernamePlaceholder"></span></h1>

        <div class="messages-container">
            <div class="send-message-container" id="box">
                <h2>Enviar Mensaje</h2>
                <form id="sendMessageForm" enctype="multipart/form-data">
                    <label for="recipient">Destinatario:</label>
                    <input type="text" id="recipient" name="recipient" required><br><br>
                    <label for="message">Mensaje:</label><br>
                    <textarea id="message" name="message" rows="4" cols="30"></textarea><br><br>
                    
                    <p id="duracion"></p>
                    <button type="button" id="btnComenzarGrabacion">Comenzar Grabación</button>
                    <button type="button" id="btnDetenerGrabacion" disabled>Detener Grabación</button>
                    <button type="button" id="btnCancelar">Cancelar</button>
                    
                    <audio id="audio-player"></audio>
                    
                    <input type="file" id="fileInput" multiple/>
                    <button id="uploadButton">Confirmar Archivo</button>

                    <button type="button" id="btnEnviarMensaje">Enviar Mensaje</button>

                </form>

                <div id="registroMessage">Online</div>
            </div>

            <div class="messages-list" id="box">
                <h2>Mensajes Recibidos</h2>
                <div id="messagesList"></div>
            </div>
        </div>
    </div>

    <audio id="notificationSound" src="https://frontendiniciar.onrender.com/audio/notification.mp3" preload="auto" style="display: none;"></audio>

    <script>
        var user = ''; // Variable global para almacenar el nombre de usuario

        // Función para mostrar notificaciones
        function mostrarNotificacionReal() {
            var audio = document.getElementById("notificationSound");
            audio.play();
        }

        // Función para editar mensaje leído
        function editarRead(id) {
            fetch('/read', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al actualizar el mensaje');
                }
                return response.json();
            })
            .then(data => {
                console.log("Mensaje marcado como leído");
            })
            .catch(error => {
                console.error('Error al actualizar el mensaje:', error);
            });
        }

        // Función para crear elemento de audio
        function crearElementoAudio(blobUrl) {
            const audioElement = document.createElement('audio');
            audioElement.src = blobUrl;
            audioElement.controls = true;
            return audioElement;
        }

        // Función para crear elemento de archivo
        function crearElementoArchivo(blobUrl, type) {
            let fileElement;

            if (type === 'application/pdf') {
                fileElement = document.createElement('iframe');
                fileElement.src = blobUrl;
                fileElement.width = '100%';
                fileElement.height = '500px';
            } else if (type.startsWith('image/')) {
                fileElement = document.createElement('img');
                fileElement.src = blobUrl;
            } else if (type.startsWith('video/')) {
                fileElement = document.createElement('video');
                fileElement.controls = true;
                fileElement.src = blobUrl;
            } else {
                fileElement = document.createElement('a');
                fileElement.href = blobUrl;
                fileElement.download = 'file';
                fileElement.textContent = 'Descargar archivo';
            }

            return fileElement;
        }

        // Función para actualizar la interfaz con mensajes recibidos
        function actualizarInterfaz(messages) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                let content = '';

                if (message.sender === user) {
                    if (message.tipo === 'texto') {
                        content = `YO: ${message.message}`;
                    } else if (message.tipo === 'audio') {
                        const audioElement = crearElementoAudio(message.blobUrl);
                        content = `${message.sender}:`;
                        messageElement.appendChild(audioElement);
                    } else if (message.tipo === 'file') {
                        const fileElement = crearElementoArchivo(message.blobUrl, message.filetype);
                        content = `${message.sender}:`;
                        messageElement.appendChild(fileElement);
                    }
                } else {
                    if (!message.read) {
                        try {
                            mostrarNotificacionReal();
                        } catch (error) {
                            console.error('Error al mostrar notificación:', error);
                        }
                        editarRead(message._id);
                    }

                    if (message.tipo === 'audio') {
                        const audioElement = crearElementoAudio(message.blobUrl);
                        content = `${message.sender}:`;
                        messageElement.appendChild(audioElement);
                    } else if (message.tipo === 'file') {
                        const fileElement = crearElementoArchivo(message.blobUrl, message.filetype);
                        content = `${message.sender}:`;
                        messageElement.appendChild(fileElement);
                    } else {
                        content = `${message.sender}: ${message.message}`;
                    }
                }

                messageElement.textContent = content;
                messagesList.appendChild(messageElement);
            });
        }

        // Función para obtener mensajes del servidor
        function obtenerMensajes() {
            const User = { username: user };

            fetch('/mensajes-recibidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(User)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener mensajes');
                }
                return response.json();
            })
            .then(data => {
                const messages = data.mensajes || [];
                actualizarInterfaz(messages);
            })
            .catch(error => {
                console.error('Error al obtener mensajes:', error);
                const messagesList = document.getElementById('messagesList');
                messagesList.textContent = 'Error al obtener mensajes. Por favor, inténtalo de nuevo más tarde.';
            })
            .finally(() => {
                console.log('Continuando la ejecución...');
            });
        }

        // Función para enviar mensajes
        document.getElementById('btnEnviarMensaje').addEventListener('click', function(event) {
            event.preventDefault();

            const recipient = document.getElementById('recipient').value;
            const message = document.getElementById('message').value;
            const tipo = 'texto'; // Ajustar según el tipo de mensaje

            const messageSend = {
                recipient: recipient,
                message: message,
                fromusername: user,
                tipo: tipo
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(messageSend)
            };

            fetch('/enviar-mensaje', options)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Error al enviar mensaje');
                }
            })
            .then(data => {
                document.getElementById('registroMessage').textContent = data.mensaje;
                setTimeout(function() {
                    document.getElementById('registroMessage').textContent = 'Online';
                }, 2000);
            })
            .catch(error => {
                console.error('Error al enviar mensaje:', error);
                document.getElementById('registroMessage').textContent = 'Error al enviar mensaje';
            });
        });

        // Función para iniciar grabación de audio
        document.getElementById('btnComenzarGrabacion').addEventListener('click', function(event) {
            // Lógica para grabación de audio
        });

        // Función para detener grabación de audio
        document.getElementById('btnDetenerGrabacion').addEventListener('click', function(event) {
            // Lógica para detener grabación de audio
        });

        // Función para cancelar grabación o limpiar formulario
        document.getElementById('btnCancelar').addEventListener('click', function(event) {
            // Lógica para cancelar grabación o limpiar formulario
        });

        // Función para manejar la carga de archivo
        document.getElementById('uploadButton').addEventListener('click', function(event) {
            // Lógica para cargar archivo
        });

        // Obtener nombre de usuario del título
        user = document.getElementById('nombre').textContent.trim().substring(12);

        // Obtener mensajes cuando se carga la página
        obtenerMensajes();

        // Obtener mensajes cada 5 segundos
        setInterval(obtenerMensajes, 5000);
    </script>
</body>
</html>
