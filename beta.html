<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://frontendiniciar.onrender.com/css/styles.css">
    <title>Bienvenido</title>
</head>
<body>
    <div class="container">
        <h1 id="nombre">Bienvenido, <span id="usernamePlaceholder"></span></h1>
        <div class="messages-container">
            <div class="send-message-container" id="box">
                <h2>Enviar Mensaje</h2>
                <form id="sendMessageForm" enctype="multipart/form-data">
                    <label for="recipient">Destinatario:</label>
                    <input type="text" id="recipient" name="recipient" required><br><br>
                    <label for="message">Mensaje:</label><br>
                    <textarea id="message" name="message" rows="4" cols="30"></textarea><br><br>
                    <p id="duracion"></p>
                    <button type="button" id="btnComenzarGrabacion">Comenzar Grabación</button>
                    <button type="button" id="btnDetenerGrabacion" disabled>Detener Grabación</button>
                    <button type="button" id="btnCancelar">Cancelar</button>
                    <audio id="audio-player"></audio>
                    <input type="file" id="fileInput" multiple/>
                    <button id="uploadButton">Confirmar Archivo</button>
                    <button type="click" id="btnEnviarMensaje">Enviar Mensaje</button>
                </form>
                <div id="registroMessage">Online</div>
            </div>
            <div class="messages-list" id="box">
                <h2>Mensajes Recibidos</h2>
                <div id="ObtenerMensajes"></div>
                <div id="messagesList"></div>
            </div>
        </div>
    </div>

    <audio id="notificationSound" src="https://frontendiniciar.onrender.com/audio/notification.mp3" preload="auto" style="display: none;"></audio>

    <script>
        // Obtener nombre de usuario del título
        var fromusername = document.getElementById('nombre').textContent;
        const user = fromusername.substring(12);
        var previousMessagesLength = 0;
        var numberOfProperties = 0;

        let formData;
        let tipo;
        let accion;
        let fileInput;

        tipo = "texto"

        // Función para mostrar notificaciones
        function mostrarNotificacionReal() {
            // Crear la notificación
            // Reproducir el sonido de notificación
            var audio = document.getElementById("notificationSound");
            audio.play().catch(function(error) {
                console.log('Reproducción automática fallida: ', error);
            });
        }

        function EditarRead(check) {
            check = { id: check }
            fetch('/read', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(check)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al actualizar el mensaje');
                }
                return response.json();
            })
            .then(data => {
                console.log("Listo check")
            })
            .catch(error => {
                console.log('Error:', error);
            });
        }

        // Actualiza la interfaz con los mensajes recibidos
        function actualizarInterfaz(messages) {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';

            messages.forEach(message => {
                id = message._id
                const messageElement = document.createElement('div');

                if (message.sender === user) {
                    if (message.tipo == "texto") {
                        messageElement.textContent = `YO: ${message.message}`;
                    } else if (message.tipo === 'audio') {
                        const audioElement = document.createElement('audio');
                        audioElement.controls = true;
                        messageElement.textContent = `${message.sender}:`;
                        const uint8Array = new Uint8Array(message.datos.data);
                        const audioBlob = new Blob([uint8Array], { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioElement.src = audioUrl;
                        messageElement.appendChild(audioElement);
                    } else if (message.tipo === 'file') {
                        messageElement.textContent = `${message.sender}:`;
                        const uint8Array = new Uint8Array(message.datos.data);
                        typeapp = String(message.filetype);
                        const fileBlob = new Blob([uint8Array], { type: typeapp });
                        const blobUrl = URL.createObjectURL(fileBlob);
                        let fileElement;
                        var link = document.createElement('a');
                        link.href = blobUrl;
                        link.target = '_blank';

                        if (typeapp === 'application/pdf') {
                            fileElement = document.createElement('iframe');
                            fileElement.src = blobUrl;
                            fileElement.width = '100%';
                            fileElement.height = '500px';
                        } else if (typeapp.startsWith('image/')) {
                            fileElement = document.createElement('img');
                            fileElement.src = blobUrl;
                        } else if (typeapp.startsWith('video/')) {
                            fileElement = document.createElement('video');
                            fileElement.controls = true;
                            fileElement.src = blobUrl;
                        } else {
                            link.download = link.name;
                            link.textContent = "Descargar archivo para abrirlo";
                        }
                        link.appendChild(fileElement);
                        messageElement.appendChild(link);
                    }
                } else {
                    if (message.read == false) {
                        mostrarNotificacionReal();
                        EditarRead(id);
                    }
                    if (message.tipo === 'audio') {
                        const audioElement = document.createElement('audio');
                        audioElement.controls = true;
                        messageElement.textContent = `${message.sender}:`;
                        const uint8Array = new Uint8Array(message.datos.data);
                        const audioBlob = new Blob([uint8Array], { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioElement.src = audioUrl;
                        messageElement.appendChild(audioElement);
                    } else if (message.tipo === 'file') {
                        messageElement.textContent = `${message.sender}:`;
                        const uint8Array = new Uint8Array(message.datos.data);
                        typeapp = String(message.filetype);
                        const fileBlob = new Blob([uint8Array], { type: typeapp });
                        const blobUrl = URL.createObjectURL(fileBlob);
                        let fileElement;
                        var link = document.createElement('a');
                        link.href = blobUrl;
                        link.target = '_blank';

                        if (typeapp === 'application/pdf') {
                            fileElement = document.createElement('iframe');
                            fileElement.src = blobUrl;
                            fileElement.width = '100%';
                            fileElement.height = '500px';
                        } else if (typeapp.startsWith('image/')) {
                            fileElement = document.createElement('img');
                            fileElement.src = blobUrl;
                        } else if (typeapp.startsWith('video/')) {
                            fileElement = document.createElement('video');
                            fileElement.controls = true;
                            fileElement.src = blobUrl;
                        } else {
                            link.download = link.name;
                            link.textContent = "Descargar archivo para abrirlo";
                        }
                        link.appendChild(fileElement);
                        messageElement.appendChild(link);
                    } else {
                        messageElement.textContent = `${message.sender}:${message.message} `;
                    }
                }
                messagesList.appendChild(messageElement);
            });

            previousMessagesLength = messages.length;
        }

        // Función para obtener los mensajes del servidor
        function obtenerMensajes() {
            const User = { username: user };
            fetch('/mensajes-recibidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(User)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener mensajes');
                }
                return response.json();
            })
            .then(data => {
                const messages = data.mensajes;
                let keyss = Object.keys(messages);
                let numberOfPropertiess = keyss.length;
                if (numberOfPropertiess >= numberOfProperties) {
                    numberOfProperties = numberOfPropertiess;
                    actualizarInterfaz(messages);
                }
            })
            .catch(error => {
                console.log('Error:', error);
                const messagesList = document.getElementById('messagesList');
                messagesList.textContent = 'Error al obtener mensajes';
            });
        }

        obtenerMensajes();
        setInterval(obtenerMensajes, 5000);

        const tieneSoporteUserMedia = () => !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        if (!tieneSoporteUserMedia()) {
            alert("Tu navegador no soporta la API de getUserMedia");
        }

        let mediaRecorder;
        let tiempoInicio;
        let idIntervalo;
        let urlParaDescargar;

        const limpiarSelect = () => {
            const $listaDeDispositivos = document.querySelector("#listaDeDispositivos");
            for (let x = $listaDeDispositivos.options.length - 1; x >= 0; x--) {
                $listaDeDispositivos.options.remove(x);
            }
        }

        const segundosATiempo = numeroDeSegundos => {
            let horas = Math.floor(numeroDeSegundos / 60 / 60);
            numeroDeSegundos -= horas * 60 * 60;
            let minutos = Math.floor(numeroDeSegundos / 60);
            numeroDeSegundos -= minutos * 60;
            numeroDeSegundos = parseInt(numeroDeSegundos);
            if (horas < 10) horas = "0" + horas;
            if (minutos < 10) minutos = "0" + minutos;
            if (numeroDeSegundos < 10) numeroDeSegundos = "0" + numeroDeSegundos;

            return `${horas}:${minutos}:${numeroDeSegundos}`;
        };

        const comenzarAContar = () => {
            tiempoInicio = Date.now();
            idIntervalo = setInterval(() => {
                const duracion = document.querySelector("#duracion");
                duracion.textContent = "Tiempo transcurrido: " + segundosATiempo((Date.now() - tiempoInicio) / 1000);
            }, 1000);
        };

        const detenerConteo = () => {
            clearInterval(idIntervalo);
            tiempoInicio = null;
        }

        const comenzarAGrabar = () => {
            if (mediaRecorder) return console.log("grabando");
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                comenzarAContar();
                const fragmentosDeAudio = [];
                mediaRecorder.addEventListener("dataavailable", evento => {
                    fragmentosDeAudio.push(evento.data);
                });
                mediaRecorder.addEventListener("stop", () => {
                    stream.getTracks().forEach(track => track.stop());
                    detenerConteo();

                    if (accion == "Detener"){
                        const blobAudio = new Blob(fragmentosDeAudio, { 'type': 'audio/webm' });
                        urlParaDescargar = URL.createObjectURL(blobAudio);
                        audioElement = document.getElementById('audio-player');
                        audioElement.src = urlParaDescargar;

                        formData = new FormData();
                        recipientt = document.getElementById('recipient').value;
                        formData.append('audio', blobAudio, String([String(recipientt), String(user)]));
                    } else {
                        audioElement = document.getElementById('audio-player');
                        audioElement.src = "";
                        urlParaDescargar = "";
                        formData = "";
                    }
                });
            })
            .catch(error => console.log("Error al obtener acceso al micrófono:", error));
            audio = document.getElementById('audio-player');
            audio.setAttribute('src', "w");
            audio.src = "";
        };

        const detenerGrabacion = () => {
            audio = document.getElementById('audio-player');
            audio.setAttribute('src', "arriba1");
            audio.src = ""
            if (!mediaRecorder) return console.log("se paro");
            mediaRecorder.stop();
            detenerConteo();
        };

        document.getElementById('btnEnviarMensaje').addEventListener('click', function(event) {
            event.preventDefault();

            recipient = document.getElementById('recipient').value;
            message = document.getElementById('message').value;

            const messageSend = {
                recipient: recipient,
                message: message,
                fromusername: user,
                tipo: tipo
            };

            decidir = "";
            typedata = "";

            if (tipo == "audio"){
                tipo = "texto";
                accion = "Cancelar";
                document.getElementById("message").disabled = false;
                document.getElementById("btnEnviarMensaje").disabled = false;
                document.getElementById("fileInput").disabled = false;
                document.getElementById("uploadButton").disabled = false;
                detenerGrabacion();
                mediaRecorder = false;
                detenerConteo();
                document.getElementById("btnDetenerGrabacion").disabled = true;
                const duracion = document.querySelector("#duracion");
                duracion.textContent = "";
                var scriptTag = document.getElementById('audio-player');
                scriptTag.removeAttribute('controls');

                decidir = formData;
                typedata = { 'type': 'audio/webm' };

            } else if (tipo == "file") {
                tipo = "texto";
                formDataa = new FormData();

                filetype = fileInput.files[0].type;
                recipientt = document.getElementById('recipient').value;
                modified_string = filetype.replace(/\//g, ',');
                mierda = "file," + modified_string;
                formDataa.append('audio', fileInput.files[0], String([String(recipientt), String(user), String(mierda)]));

                document.getElementById("message").disabled = false;
                document.getElementById("btnEnviarMensaje").disabled = false;
                document.getElementById("fileInput").disabled = false;
                document.getElementById("uploadButton").disabled = false;
                document.getElementById("btnComenzarGrabacion").disabled = false;

                decidir = formDataa;
                typedata = { 'type': 'audio/webm' };

            } else {
                decidir = JSON.stringify(messageSend);
                typedata = { 'Content-Type': 'application/json' };
            }

            fetch('/enviar-mensaje', {
                method: 'POST',
                headers: typedata,
                body: decidir
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Error');
                }
            })
            .then(data => {
                function MensajeEnviado() {
                    document.getElementById('registroMessage').textContent = data.mensaje;

                    setTimeout(function() {
                        document.getElementById('registroMessage').textContent = "Online";
                    }, 2000);
                }
                MensajeEnviado();
            })
            .catch(error => {
                console.log('Error al enviar:', error);
                document.getElementById('registroMessage').textContent = 'Error al enviar';
            });
        });

        document.getElementById('btnComenzarGrabacion').addEventListener('click', function(event) {
            document.getElementById("message").disabled = true;
            document.getElementById("btnEnviarMensaje").disabled = true;
            document.getElementById("fileInput").disabled = true;
            document.getElementById("uploadButton").disabled = true;
            document.getElementById("btnDetenerGrabacion").disabled = false;

            var audio = document.getElementById('audio-player');
            audio.setAttribute('controls', true);
            event.preventDefault();
            comenzarAGrabar();
        });

        document.getElementById('btnDetenerGrabacion').addEventListener('click', function(event) {
            accion = "Detener";
            tipo = "audio";
            event.preventDefault();
            detenerGrabacion();
            mediaRecorder = false;
            document.getElementById("btnEnviarMensaje").disabled = false;
            document.getElementById("btnDetenerGrabacion").disabled = true;
        });

        document.getElementById('btnCancelar').addEventListener('click', function(event) {
            event.preventDefault();
            tipo = "texto";
            accion = "Cancelar";
            fileInput.value = '';
            document.getElementById("message").disabled = false;
            document.getElementById("btnEnviarMensaje").disabled = false;
            document.getElementById("fileInput").disabled = false;
            document.getElementById("uploadButton").disabled = false;
            document.getElementById('btnComenzarGrabacion').disabled = false;

            detenerGrabacion();
            mediaRecorder = false;
            detenerConteo();
            document.getElementById("btnDetenerGrabacion").disabled = true;
            const duracion = document.querySelector("#duracion");
            duracion.textContent = "";
            var scriptTag = document.getElementById('audio-player');
            scriptTag.removeAttribute('controls');
        });

        document.getElementById("uploadButton").addEventListener('click', function(event) {
            tipo = "file";
            fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('Por favor seleccione un archivo.');
            }

            event.preventDefault();
            document.getElementById("btnComenzarGrabacion").disabled = true;
            document.getElementById("btnDetenerGrabacion").disabled = true;
            document.getElementById("message").disabled = true;
            document.getElementById("btnEnviarMensaje").disabled = false;
        });
    </script>
</body>
</html>
